name: Playwright Prod Tests # –ò–º—è
on: 
  workflow_dispatch: # Manual –∑–∞–ø—É—Å–∫ –∏–∑ UI
  repository_dispatch:
    types: [deploy-trigger] # –¢—Ä–∏–≥–≥–µ—Ä –∏–∑ deploy.yml
jobs:
  test:
    timeout-minutes: 10 #timeout-minutes: –ú–∞–∫—Å 10 –º–∏–Ω –Ω–∞ job
    runs-on: ubuntu-latest
    env:
      TZ: Asia/Yekaterinburg
      BASE_URL: https://qaspace.ru
      CI: true  # test new - –¥–ª—è Playwright –æ—Ç–∫–ª—é—á–∞–µ—Ç headless=false
    steps:
    - uses: actions/checkout@v4 # –ö–ª–æ–Ω–∏—Ä—É–µ—Ç —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π
    - uses: actions/setup-node@v4 # –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –Ω–æ–¥—ã
      with:
        node-version: 20
        cache: 'npm' # –ê–≤—Ç–æ-–∫—ç—à npm
    - name: Cache apt lists
      uses: actions/cache@v4
      with:
        path: /var/lib/apt/lists
        key: ${{ runner.os }}-apt-ubuntu-${{ hashFiles('**/package.json') }}
        restore-keys: |
          ${{ runner.os }}-apt-ubuntu-
    - name: Install deps
      run: npm ci
    - name: Install Playwright
      run: npx playwright install --with-deps  # –ë—Ä–∞—É–∑–µ—Ä—ã + —Å–∏—Å—Ç–µ–º–Ω—ã–µ libs. –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç Chromiumgitr ad
    - name: Capture start time
      id: start-time
      run: |
        export TZ=Asia/Yekaterinburg
        echo "start_time=$(date '+%H:%M-%d.%m')" >> $GITHUB_OUTPUT
        echo "start_sec=$(date +%s)" >> $GITHUB_OUTPUT
    - name: Run Tests
      run: npx playwright test --project=prod-chromium --workers=2 # –ó–∞–ø—É—Å–∫ 2 —Ç–µ—Å—Ç–æ–≤ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ
      env:
        BASE_URL: https://qaspace.ru
    - name: Upload Report
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: playwright-report
        path: playwright-report/
        retention-days: 30
    - name: Send Telegram notification
      if: always()
      env:
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
        TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
      run: |
        export TZ=Asia/Yekaterinburg
        START_TIME="${{ steps.start-time.outputs.start_time }}"
        curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" -H "Content-Type: application/json" -d "{\"chat_id\":\"${TELEGRAM_CHAT_ID}\",\"text\":\"üß™ QASpace Prod Tests #${{ github.run_number }} - ${{ job.status }} (${START_TIME})\"}"
