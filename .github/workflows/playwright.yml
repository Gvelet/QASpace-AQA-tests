name: Playwright Prod Tests
on:
  workflow_dispatch:
  repository_dispatch:
    types: [deploy-trigger]
jobs:
  test:
    timeout-minutes: 10
    runs-on: ubuntu-latest
    env:
      TZ: Asia/Yekaterinburg
      BASE_URL: https://qaspace.ru
    steps:
    - uses: actions/checkout@v4
    - name: Cache npm dependencies
      uses: actions/cache@v4
      with:
        path: ~/.npm
        key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
        restore-keys: |
          ${{ runner.os }}-node-
    - uses: actions/setup-node@v4
      with:
        node-version: 20
        cache: 'npm'
    - name: Cache apt lists
      uses: actions/cache@v4
      with:
        path: /var/lib/apt/lists
        key: ${{ runner.os }}-apt-ubuntu-${{ hashFiles('**/package.json') }}
        restore-keys: |
          ${{ runner.os }}-apt-ubuntu-
    - name: Install deps
      run: npm ci
    - name: Install Playwright
      run: npx playwright install --with-deps
    - name: Capture start time
      id: start-time
      run: |
        export TZ=Asia/Yekaterinburg
        echo "start_time=$(date '+%H:%M-%d.%m')" >> $GITHUB_OUTPUT
        echo "start_sec=$(date +%s)" >> $GITHUB_OUTPUT
    - name: Run Tests
      run: npx playwright test --project=prod-chromium
      env:
        BASE_URL: https://qaspace.ru
    - name: Upload Report
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: playwright-report
        path: playwright-report/
        retention-days: 30
    - name: Send Telegram notification
      if: always()
      env:
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
        TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
      run: |
        export TZ=Asia/Yekaterinburg
        START_TIME="${{ steps.start-time.outputs.start_time }}"
        START_SEC="${{ steps.start-time.outputs.start_sec }}"
        END_SEC=$(date +%s)
        DURATION=$((END_SEC - START_SEC))
        
        # âœ… ĞŸĞ ĞĞ’Ğ•Ğ Ğ¯Ğ•Ğœ Playwright Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚, Ğ° Ğ½Ğµ job.status!
        if [ -f "playwright-report/results.json" ] && grep -q '"status":"passed"' "playwright-report/results.json" 2>/dev/null; then
          STATUS="âœ… Ğ’ÑĞµ Ñ‚ĞµÑÑ‚Ñ‹ Ğ¿Ñ€Ğ¾ÑˆĞ»Ğ¸"
        else
          STATUS="âŒ Ğ¢ĞµÑÑ‚Ñ‹ Ğ½Ğµ Ğ¿Ñ€Ğ¾ÑˆĞ»Ğ¸"
        fi
        
        curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
          -H "Content-Type: application/json" \
          -d "{\"chat_id\":\"${TELEGRAM_CHAT_ID}\",\"parse_mode\":\"Markdown\",\"text\":\"ğŸ§ª QASpace Prod Tests #${{ github.run_number }}\\nğŸ”— https://qaspace.ru\\n\\n**SÑ‚Ğ°Ñ‚ÑƒÑ:** ${STATUS}\\n**ğŸ“…** ${START_TIME} - â±ï¸ ${DURATION}s\\n\\n**Ğ’Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ñ:**\\nğŸ“ [ĞÑ€Ñ…Ğ¸Ğ² Ğ¾Ñ‚Ñ‡ĞµÑ‚Ğ°](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})"